{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard Ghost Recon{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-3 site-title">
        📊 Dashboard
        <img src="{% static 'img/logo.png' %}" class="logo" alt="Ghost Recon Logo">
        Ghost Recon
    </h2>

    <div class="nav-switcher mb-4">
        <button data-nav="default" class="btn btn-sm btn-outline-secondary me-2">Nav por Defecto</button>
        <button data-nav="alt"     class="btn btn-sm btn-outline-secondary me-2">Nav Alternativa</button>
        <button data-nav="act"     class="btn btn-sm btn-outline-secondary">Nav Activa</button>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="alert alert-primary"><strong>Total de intentos:</strong> {{ total }}</div>
        </div>
        <div class="col-md-6">
            <div class="alert alert-danger"><strong>Reconocidos:</strong> {{ reconocidos }}</div>
        </div>
    </div>

    <form method="get" class="mb-4 d-flex align-items-center">
        <label for="limite" class="me-2 mb-0">Mostrar últimos:</label>
        <select name="limite" id="limite" class="form-select w-auto" onchange="this.form.submit()">
            <option value="10"  {% if limite == 10  %}selected{% endif %}>10</option>
            <option value="20"  {% if limite == 20  %}selected{% endif %}>20</option>
            <option value="50"  {% if limite == 50  %}selected{% endif %}>50</option>
            <option value="100" {% if limite == 100 %}selected{% endif %}>100</option>
        </select>
    </form>

    <table class="table table-hover table-bordered align-middle">
        <thead class="table-dark">
            <tr>
                <th>📅 Fecha</th>
                <th>🎯 Reconocido</th>
                <th>📸 Captura</th>
                <th>⏱ Tiempo (s)</th>
            </tr>
        </thead>
        <tbody id="tabla-intentos">
            {% for intento in recientes %}
            <tr>
                <td>{{ intento.fecha|date:"Y-m-d H:i:s" }}</td>
                <td>{% if intento.reconocio %}<span class="text-success">✅ Sí</span>{% else %}<span class="text-danger">❌ No</span>{% endif %}</td>
                <td>{% if intento.captura %}<a href="{{ intento.captura.url }}" target="_blank">Ver</a>{% else %}<span class="text-muted">No disponible</span>{% endif %}</td>
                <td>{{ intento.tiempo_navegacion }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="4" class="text-center text-muted">No hay intentos para mostrar.</td></tr>
            {% endfor %}
        </tbody>
    </table>

    {% if ultimo_intento %}
        {% with intento=ultimo_intento.0 %}
        <hr class="my-5">
        <h4 class="text-primary">🧩 Último intento registrado</h4>
        <ul class="list-group mb-4">
            <li class="list-group-item"><strong>📅 Fecha:</strong> {{ intento.fecha|date:"Y-m-d H:i" }}</li>
            <li class="list-group-item"><strong>🌐 URL:</strong> {{ intento.url }}</li>
            <li class="list-group-item"><strong>🎯 Reconocido:</strong> {% if intento.reconocio %}<span class="badge bg-success">Sí</span>{% else %}<span class="badge bg-secondary">No</span>{% endif %}</li>
            <li class="list-group-item"><strong>⏱ Tiempo navegación:</strong> {{ intento.tiempo_navegacion }}s</li>
        </ul>
        <a href="{% url 'detalle_intento' intento.id %}" class="btn btn-outline-dark mb-4">🔍 Ver detalle</a>
        {% endwith %}
    {% endif %}

    <audio id="alerta-sonora">
        <source src="https://notificationsounds.com/storage/sounds/file-sounds-1153-pristine.mp3" type="audio/mpeg">
    </audio>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", function(){
  const setNavUrl       = "{% url 'set_nav' %}";
  const ultimosJsonUrl  = "{% url 'ultimos_intentos_json' %}";
  const csrfToken       = "{{ csrf_token }}";

  // Cambiar nav
  document.querySelectorAll('.nav-switcher button').forEach(btn => {
    btn.addEventListener('click', () => {
      const navType = btn.dataset.nav;
      fetch(setNavUrl, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken,
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: 'nav_type=' + navType
      }).then(r => r.json()).then(js => {
        if (js.status === 'ok') location.reload();
        else alert('Error al cambiar navegación');
      });
    });
  });

  // Recarga periódica de tabla
  function cargarIntentos() {
    fetch(ultimosJsonUrl)
      .then(res => res.json())
      .then(datos => {
        const tbody = document.getElementById('tabla-intentos');
        tbody.innerHTML = '';
        datos.forEach(i => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${i.fecha}</td>
            <td>${i.reconocio ? '✅ Sí' : '❌ No'}</td>
            <td>${i.captura ? `<a href="${i.captura}" target="_blank">Ver</a>` : 'No disponible'}</td>
            <td>${i.tiempo}</td>
          `;
          tbody.appendChild(tr);
        });
      });
  }
  setInterval(cargarIntentos, 5000);
});
</script>
{% endblock %}
