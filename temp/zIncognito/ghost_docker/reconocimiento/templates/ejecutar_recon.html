{% extends 'base.html' %}
{% load form_filters %}
{% block content %}

<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="card shadow-lg rounded-4">
        <div class="card-body p-5">
          <h3 class="card-title text-center mb-4 text-info">üöÄ Ejecutar Ghost Recon</h3>

          <form method="post" novalidate>
            {% csrf_token %}

            <div class="row mb-4">
              <div class="col-md-6">
                <label class="form-label d-block">{{ form.modo.label }}</label>
                {% for radio in form.modo %}
                  <div class="form-check">
                    {{ radio.tag }}
                    <label class="form-check-label ms-1" for="{{ radio.id_for_label }}">{{ radio.choice_label }}</label>
                  </div>
                {% endfor %}
              </div>
              <div class="col-md-6" id="urls_section" style="display: none;">
                <label class="form-label d-block">{{ form.urls.label }}</label>
                {% for checkbox in form.urls %}
                  <div class="form-check">
                    {{ checkbox.tag }}
                    <label class="form-check-label" for="{{ checkbox.id_for_label }}">{{ checkbox.choice_label }}</label>
                  </div>
                {% endfor %}
              </div>
            </div>

            <div id="manual_section" class="mb-4" style="display: none;">
              <label class="form-label">{{ form.url_manual.label }}</label>
              {{ form.url_manual|add_class:"form-control" }}
            </div>

            <div class="row mb-4">
              <div class="col-md-6">
                <label class="form-label">{{ form.modo_calculo.label }}</label>
                {{ form.modo_calculo|add_class:"form-select" }}
              </div>
              <div class="col-md-6">
                <label class="form-label">{{ form.identificadores.label }}</label>
                {{ form.identificadores|add_class:"form-control" }}
              </div>
            </div>

            <div class="row mb-4">
              <div class="col-md-4">
                <label class="form-label">{{ form.repeticiones.label }}</label>
                {{ form.repeticiones|add_class:"form-control" }}
              </div>
              <div class="col-md-4">
                <label class="form-label">{{ form.delay.label }}</label>
                {{ form.delay|add_class:"form-control" }}
              </div>
              <div class="col-md-4">
                <label class="form-label">{{ form.tiempo_navegacion.label }}</label>
                {{ form.tiempo_navegacion|add_class:"form-control" }}
                {% if form.tiempo_navegacion.help_text %}
                  <div class="form-text text-muted">{{ form.tiempo_navegacion.help_text }}</div>
                {% endif %}
              </div>
            </div>

            <div id="barra-cuenta" class="mt-4" style="display: none;">
              <h5 class="text-light">‚è≥ Tiempo restante: <span id="tiempo-restante"></span> segundos</h5>
              <div class="progress" style="height: 20px;">
                <div id="progreso-tiempo" class="progress-bar progress-bar-striped bg-info" role="progressbar" style="width: 100%"></div>
              </div>
            </div>

            <div id="alerta-identificador" class="alert alert-danger mt-4 d-none" role="alert">
              ‚ö†Ô∏è Se detect√≥ un identificador sensible en una de las p√°ginas durante la navegaci√≥n.
            </div>

            <div class="d-grid">
              <button type="submit" class="btn btn-dark btn-lg rounded-pill">
                <i class="bi bi-rocket-takeoff"></i> Lanzar An√°lisis
              </button>
            </div>

            {% if messages %}
              <div class="mt-4">
                {% for msg in messages %}
                  <div class="alert alert-{{ msg.tags }} alert-dismissible fade show" role="alert">
                    {{ msg }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
                  </div>
                {% endfor %}
              </div>
            {% endif %}

          </form>

          {% if request.user.is_staff %}
          <hr class="mt-5">
          <form method="post" action="{% url 'reinicio_seguro' %}" id="reinicio-form">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger btn-sm float-end" onclick="return confirm('¬øConfirmas el reinicio seguro de red, Tor y servicios?')">
              <i class="bi bi-shield-lock-fill me-1"></i> Reinicio Seguro
            </button>
          </form>
          {% endif %}

          <div id="toastContainer" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1055"></div>
          <div id="estadoTor" class="text-muted small mt-3"><i class="bi bi-circle"></i> Estado de Tor: <span id="tor-status">verificando...</span></div>

        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const modoRadios = document.querySelectorAll('input[name="modo"]');
    const urlsSection = document.getElementById("urls_section");
    const manualSection = document.getElementById("manual_section");

    function toggleSections() {
      const selected = document.querySelector('input[name="modo"]:checked');
      if (!selected) return;
      const value = selected.value;
      urlsSection.style.display = value === "lista" ? "block" : "none";
      manualSection.style.display = value === "manual" ? "block" : "none";
    }

    modoRadios.forEach(r => r.addEventListener('change', toggleSections));
    toggleSections();

    // Verificar estado de Tor
    function verificarTor() {
      fetch("https://check.torproject.org/", {mode: "no-cors"})
        .then(() => {
          document.getElementById("tor-status").textContent = "activo";
          document.querySelector("#estadoTor i").classList.replace("bi-circle", "bi-check-circle-fill");
          document.querySelector("#estadoTor i").classList.add("text-success");
        })
        .catch(() => {
          document.getElementById("tor-status").textContent = "inactivo";
          document.querySelector("#estadoTor i").classList.replace("bi-circle", "bi-x-circle-fill");
          document.querySelector("#estadoTor i").classList.add("text-danger");
        });
    }
    verificarTor();
    setInterval(verificarTor, 30000);

    // Mostrar toast tras reinicio seguro
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get("reinicio") === "ok") {
      const toastHTML = `
        <div class="toast show align-items-center text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">
              üõ°Ô∏è Reinicio seguro en proceso. Revisa logs si es necesario.
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
          </div>
        </div>`;
      document.getElementById("toastContainer").innerHTML = toastHTML;
    }
  });
</script>

{% endblock %}
