{% extends 'base.html' %} {% block title %}Detalle de Transferencia{% endblock
%} {% block content %}
<style>
  h1.text-center {
    font-size: 2.5rem !important;
  }
  .custom-card {
    border-radius: 1rem;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    background: linear-gradient(135deg, #ffffff 0%, #f1f3f5 100%);
    border: none;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  .custom-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
  }
  .custom-card-header {
    background: linear-gradient(45deg, #343a40, #495057);
    color: #fff;
    font-weight: 600;
    font-size: 1.3rem;
    padding: 1rem 1.5rem;
    border-top-left-radius: 1rem;
    border-top-right-radius: 1rem;
  }
  .custom-card-body {
    padding: 1.5rem;
  }
  .table-custom {
    width: 100%;
    border-collapse: collapse;
  }
  .table-custom th,
  .table-custom td {
    padding: 0.4rem 0.6rem;
  }
  .table-custom thead {
    background-color: #e9ecef;
  }
  .table-custom tbody tr:hover {
    background-color: rgba(52, 58, 64, 0.05);
  }
  .log-content::-webkit-scrollbar {
    width: 6px;
  }
  .log-content::-webkit-scrollbar-thumb {
    background-color: rgba(0, 0, 0, 0.3);
    border-radius: 3px;
  }
  .log-content {
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.3) transparent;
  }
</style>

<div class="container-fluid">
  <div class="card custom-card mb-4">
    <div
      class="custom-card-header d-flex justify-content-between align-items-center"
    >
      <h2 class="mb-0">Transferencia {{ transferencia.payment_id }}</h2>
      <div>
        <a href="{% url 'dashboard' %}" class="btn btn-outline-info me-2">
          <i class="bi bi-arrow-left"></i> Volver al Listado
        </a>
        <a
          href="{% url 'descargar_pdfGPT3' transferencia.payment_id %}"
          class="btn btn-outline-secondary"
        >
          <i class="bi bi-file-earmark-pdf"></i> Descargar PDF
        </a>
      </div>
    </div>
    <div class="card-body custom-card-body">
      <dl class="row">
        <dt class="col-sm-3">Fecha de ejecución</dt>
        <dd class="col-sm-9">
          {{ transferencia.requested_execution_date|default:"-" }}
        </dd>
        <dt class="col-sm-3">Estado</dt>
        <dd class="col-sm-9">
          <span class="badge bg-{{ transferencia.get_status_color }}">
            {{ transferencia.get_transaction_status_display }}
          </span>
        </dd>
        <dt class="col-sm-3">Auth ID</dt>
        <dd class="col-sm-9">{{ transferencia.auth_id }}</dd>
        <dt class="col-sm-3">Instruction ID</dt>
        <dd class="col-sm-9">
          {{ transferencia.payment_identification.instruction_id }}
        </dd>
        <dt class="col-sm-3">End-to-End ID</dt>
        <dd class="col-sm-9">
          {{ transferencia.payment_identification.end_to_end_id }}
        </dd>
        <dt class="col-sm-3">Tipo de Transferencia</dt>
        <dd class="col-sm-9">
          {{ transferencia.payment_type_information.service_level_code }} {{
          transferencia.payment_type_information.local_instrument_code }} {{
          transferencia.payment_type_information.category_purpose_code }}
        </dd>
        <dt class="col-sm-3">Monto</dt>
        <dd class="col-sm-9">
          {{ transferencia.instructed_amount.amount }} {{
          transferencia.instructed_amount.currency }}
        </dd>
        <dt class="col-sm-3">Beneficiario</dt>
        <dd class="col-sm-9">
          {{ transferencia.creditor.creditor_name }} {{
          transferencia.credito_account.iban }}
        </dd>
      </dl>

      <div class="mt-4 p-3 bg-light border rounded">
        <h5>Logs de Transacción</h5>
        {% if log_files_content %} {% for nombre, contenido in
        log_files_content.items %}
        <div class="mb-3">
          <h6 class="text-primary">{{ nombre }}</h6>
          <div
            class="border rounded p-2 bg-white log-content"
            style="max-height: 300px; overflow-y: auto"
          >
            <pre class="mb-0">{{ contenido }}</pre>
          </div>
        </div>
        {% endfor %} {% else %}
        <p class="text-muted">
          No hay logs disponibles para esta transferencia.
        </p>
        {% endif %}
      </div>

      <div class="mt-4 p-3 bg-light border rounded">
        <h5>Archivos Relacionados</h5>
        {% for archivo, contenido in archivos.items %}
        <div class="mb-3">
          <h6 class="text-primary">{{ archivo|capfirst }}</h6>
          {% if contenido %}
          <div
            class="border rounded p-2 bg-white log-content"
            style="max-height: 300px; overflow-y: auto"
          >
            <pre class="mb-0">{{ contenido }}</pre>
          </div>
          {% else %}
          <p class="text-muted">
            El archivo {{ archivo }} no contiene información.
          </p>
          {% endif %}
        </div>
        {% endfor %}
      </div>

      <div class="mt-4 p-3 bg-light border rounded">
        <h5>Errores</h5>
        {% if transferencia.error %}
        <div class="alert alert-danger">{{ transferencia.error }}</div>
        {% else %}
        <p class="text-muted">
          No hay errores registrados para esta transferencia.
        </p>
        {% endif %}
      </div>

      <hr class="my-5" />

      <div class="accordion" id="accordionOTP">
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingEnviar">
            <button
              class="accordion-button"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#collapseEnviar"
              aria-expanded="true"
              aria-controls="collapseEnviar"
            >
              Enviar Transferencia
            </button>
          </h2>
          <div
            id="collapseEnviar"
            class="accordion-collapse collapse show"
            aria-labelledby="headingEnviar"
            data-bs-parent="#accordionOTP"
          >
            <div class="accordion-body">
              {% if transferencia and transferencia.payment_id %}
              <form
                method="post"
                action="{% url 'enviar_transferenciaGPT3' transferencia.payment_id %}"
                class="row g-3"
              >
                {% csrf_token %}
                <div class="col-md-6">
                  <label for="otpEnviar" class="form-label">Código OTP</label>
                  <input
                    type="text"
                    class="form-control"
                    id="otpEnviar"
                    name="otp"
                    placeholder="Introduce tu OTP"
                    required
                    maxlength="8"
                  />
                </div>
                <div
                  class="col-12 d-grid gap-2 d-md-flex justify-content-md-end mt-3"
                >
                  <button type="submit" class="btn btn-success">
                    <i class="bi bi-send-check"></i> Enviar Transferencia
                  </button>
                </div>
              </form>
              {% else %}
              <div class="alert alert-warning">
                No se puede enviar la transferencia porque no tiene un ID
                válido.
              </div>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="accordion-item">
          <h2 class="accordion-header" id="headingCancelar">
            <button
              class="accordion-button collapsed"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#collapseCancelar"
              aria-expanded="false"
              aria-controls="collapseCancelar"
            >
              Cancelar Transferencia
            </button>
          </h2>
          <div
            id="collapseCancelar"
            class="accordion-collapse collapse"
            aria-labelledby="headingCancelar"
            data-bs-parent="#accordionOTP"
          >
            <div class="accordion-body">
              {% if transferencia and transferencia.payment_id %}
              <form
                method="post"
                action="{% url 'cancelar_transferenciaGPT3' transferencia.payment_id %}"
                class="row g-3"
              >
                {% csrf_token %}
                <div class="col-md-6">
                  <label for="otpCancelar" class="form-label">Código OTP</label>
                  <input
                    type="text"
                    class="form-control"
                    id="otpCancelar"
                    name="otp"
                    placeholder="Introduce tu OTP para cancelar"
                    required
                    maxlength="8"
                  />
                </div>
                <div
                  class="col-12 d-grid gap-2 d-md-flex justify-content-md-end mt-3"
                >
                  <button type="submit" class="btn btn-danger">
                    <i class="bi bi-x-octagon"></i> Cancelar Transferencia
                  </button>
                </div>
              </form>
              {% else %}
              <div class="alert alert-warning">
                No se puede cancelar la transferencia porque no tiene un ID
                válido.
              </div>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="accordion-item">
          <h2 class="accordion-header" id="headingRetry">
            <button
              class="accordion-button collapsed"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#collapseRetry"
              aria-expanded="false"
              aria-controls="collapseRetry"
            >
              Reintentar Segundo Factor (OTP Retry)
            </button>
          </h2>
          <div
            id="collapseRetry"
            class="accordion-collapse collapse"
            aria-labelledby="headingRetry"
            data-bs-parent="#accordionOTP"
          >
            <div class="accordion-body">
              {% if transferencia and transferencia.payment_id %}
              <form
                method="post"
                action="{% url 'retry_second_factorGPT3' transferencia.payment_id %}"
                class="row g-3"
              >
                {% csrf_token %}
                <div class="col-md-6">
                  <label for="otpRetry" class="form-label">Código OTP</label>
                  <input
                    type="text"
                    class="form-control"
                    id="otpRetry"
                    name="otp"
                    placeholder="Introduce tu nuevo OTP"
                    required
                    maxlength="8"
                  />
                </div>
                <input type="hidden" name="action" value="CREATE" />
                <input
                  type="hidden"
                  name="authId"
                  value="{{ transferencia.auth_id }}"
                />
                <div
                  class="col-12 d-grid gap-2 d-md-flex justify-content-md-end mt-3"
                >
                  <button type="submit" class="btn btn-warning">
                    <i class="bi bi-arrow-repeat"></i> Reintentar Segundo Factor
                  </button>
                </div>
              </form>
              {% else %}
              <div class="alert alert-warning">
                No se puede reintentar el segundo factor porque no tiene un ID
                válido.
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
