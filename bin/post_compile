#!/bin/bash

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(realpath "$SCRIPT_DIR/..")"

LOG_DIR="$PROJECT_DIR/logs"
LOG_FILE="$LOG_DIR/post_compile.log"
DESTINO="$PROJECT_DIR/schemas/keys/ecdsa_private_key.pem"

mkdir -p "$(dirname "$DESTINO")"
mkdir -p "$LOG_DIR"

echo "üîê Restaurando clave privada desde PRIVATE_KEY_B64..." | tee -a "$LOG_FILE"

STATUS="OK"

if [ -n "${PRIVATE_KEY_B64:-}" ]; then
    echo "$PRIVATE_KEY_B64" | base64 -d > "$DESTINO" 2>>"$LOG_FILE"
    if [ $? -eq 0 ]; then
        chmod 600 "$DESTINO"
        if grep -q "BEGIN PRIVATE KEY" "$DESTINO"; then
            echo "‚úÖ Clave restaurada correctamente en $DESTINO" | tee -a "$LOG_FILE"
        else
            echo "‚ùå Clave restaurada no v√°lida (no contiene BEGIN PRIVATE KEY). Eliminando." | tee -a "$LOG_FILE"
            rm -f "$DESTINO"
            STATUS="INVALID"
        fi
    else
        echo "‚ùå Error al decodificar PRIVATE_KEY_B64. Clave no restaurada." | tee -a "$LOG_FILE"
        rm -f "$DESTINO"
        STATUS="DECODE_ERROR"
    fi
else
    echo "‚ö†Ô∏è PRIVATE_KEY_B64 no est√° definido. Clave no restaurada." | tee -a "$LOG_FILE"
    STATUS="UNDEFINED"
fi

echo ""
case "$STATUS" in
    "OK")
        echo "üîí Resultado post_compile: ‚úÖ CLAVE OK" | tee -a "$LOG_FILE"
        ;;
    "INVALID")
        echo "üîí Resultado post_compile: ‚ùå CLAVE INV√ÅLIDA (no es PEM)" | tee -a "$LOG_FILE"
        ;;
    "DECODE_ERROR")
        echo "üîí Resultado post_compile: ‚ùå ERROR EN DECODIFICACI√ìN" | tee -a "$LOG_FILE"
        ;;
    "UNDEFINED")
        echo "üîí Resultado post_compile: ‚ö†Ô∏è VARIABLE PRIVATE_KEY_B64 NO DEFINIDA" | tee -a "$LOG_FILE"
        ;;
esac
